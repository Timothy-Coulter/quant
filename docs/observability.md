# Observability

The backtester now exposes a first-class observability surface that combines
structured logging with operational metrics so long-running simulations can be
debugged without attaching profilers or sprinkling `print()` statements.

## Structured Logging

- `backtester.core.logger.get_backtester_logger(__name__, run_id=..., symbol=...)`
  returns a child logger of the shared `backtester` logger so every component
  inherits the same handlers and formatting.
- Each record automatically includes `run_id` and `symbol` fields, so log lines
  look like: `2024-05-01 12:00:00 | INFO | backtester.core.backtest_engine |
  run=1ab3f2c4 symbol=SPY | ...`.
- Use `bind_logger_context(logger, symbol="MSFT")` when you need to add or update
  contextual keys on an existing logger (for example, when a strategy begins
  processing a specific instrument).

```python
from backtester.core.logger import get_backtester_logger

logger = get_backtester_logger(__name__, run_id="dry-run-42", symbol="SPY")
logger.info("Bootstrapping strategy bundle")
```

## Operational Metrics

`PerformanceAnalyzer` now maintains an `OperationalMetrics` snapshot that tracks:

- Average and peak tick latency in milliseconds.
- Average and peak event queue depth reported by the event bus.
- Total processed events and average throughput (events per second).

`BacktestEngine` emits a sample at the end of every tick, so the aggregated
statistics automatically appear in `performance['operational_metrics']` and in
the text report generated by `generate_performance_report()`.

```python
results = engine.run_backtest()
ops = results['performance']['operational_metrics']
print(f"Avg latency: {ops['avg_latency_ms']:.2f} ms, "
      f"avg throughput: {ops['avg_throughput_per_sec']:.1f} ev/s")
```

The metrics block is also rendered in the performance report:

```
OPERATIONAL METRICS:
Samples Captured:       512
Avg Tick Latency:       3.27 ms
Peak Tick Latency:      7.94 ms
Avg Queue Depth:        2.10
Peak Queue Depth:       8
Events Processed:       9216
Avg Throughput:         2862.83 ev/s
```

## Troubleshooting Tips

- If you wire a custom event bus into `BacktestEngine`, call
  `bind_logger_context(event_bus.logger, run_id=engine.run_id)` so queue depth
  logs continue to carry the run identifier.
- Additional context (portfolio ID, strategy ID, etc.) can be supplied on a
  per-log basis via `logger.info("...", extra={"symbol": "QQQ"})`. The context
  filter will only fill values that are missing, so inline overrides are safe.
